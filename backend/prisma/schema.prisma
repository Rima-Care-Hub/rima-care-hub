// Prisma schema for payments, sessions, and webhooks
// Database: PostgreSQL

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum PaymentStatus {
  pending
  paid
  failed
}

enum TransactionStatus {
  pending
  success
  failed
}

enum SellerType {
  agency
  caregiver
}

enum WalletOwnerType {
  platform
  agency
  caregiver
}

enum PayoutStatus {
  pending
  approved
  rejected
  paid
}

model PaymentSession {
  id           String        @id @default(cuid())
  reference    String        @unique
  amountMinor  Int
  currency     String        @default("NGN")
  sellerType   SellerType
  sellerId     String
  status       PaymentStatus @default(pending)
  metadata     Json?
  provider     String        @default("paystack")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Transaction {
  id           String             @id @default(cuid())
  reference    String             @unique
  amountMinor  Int
  platformFeeMinor Int             @default(0)
  netAmountMinor   Int             @default(0)
  currency     String             @default("NGN")
  sellerType   SellerType
  sellerId     String
  status       TransactionStatus  @default(pending)
  provider     String             @default("paystack")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  ledgerEntries LedgerEntry[]
}

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String
  eventType String
  signature String?
  body      Json?
  hash      String   @unique
  createdAt DateTime @default(now())
}

model Wallet {
  id           String          @id @default(cuid())
  ownerType    WalletOwnerType
  ownerId      String
  currency     String          @default("NGN")
  balanceMinor Int             @default(0)
  ledgerEntries LedgerEntry[]
  payoutRequests PayoutRequest[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@unique([ownerType, ownerId, currency])
}

model LedgerEntry {
  id                String       @id @default(cuid())
  walletId          String
  wallet            Wallet       @relation(fields: [walletId], references: [id])
  transactionId     String?
  transaction       Transaction? @relation(fields: [transactionId], references: [id])
  amountMinor       Int
  balanceAfterMinor Int
  description       String?
  createdAt         DateTime     @default(now())
}

model PayoutRequest {
  id          String       @id @default(cuid())
  walletId    String
  wallet      Wallet       @relation(fields: [walletId], references: [id])
  amountMinor Int
  status      PayoutStatus @default(pending)
  requestedAt DateTime     @default(now())
  processedAt DateTime?
  createdAt   DateTime     @default(now())
}
