// Prisma schema for payments, sessions, and webhooks
// Database: SQLite

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// SQLite doesn't support enums, using String instead

model PaymentSession {
  id           String   @id @default(cuid())
  reference    String   @unique
  amountMinor  Int
  currency     String   @default("NGN")
  sellerType   String   // agency | caregiver
  sellerId     String
  status       String   @default("pending") // pending | paid | failed
  metadata     String?  // JSON stored as TEXT
  provider     String   @default("paystack")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Transaction {
  id              String         @id @default(cuid())
  reference       String         @unique
  amountMinor     Int
  platformFeeMinor Int           @default(0)
  netAmountMinor  Int            @default(0)
  currency        String         @default("NGN")
  sellerType      String         // agency | caregiver
  sellerId        String
  status          String         @default("pending") // pending | success | failed
  provider        String         @default("paystack")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  ledgerEntries   LedgerEntry[]
}

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String
  eventType String
  signature String?
  body      String?  // JSON stored as TEXT
  hash      String   @unique
  createdAt DateTime @default(now())
}

model Wallet {
  id             String          @id @default(cuid())
  ownerType      String          // platform | agency | caregiver
  ownerId        String
  currency       String          @default("NGN")
  balanceMinor   Int             @default(0)
  ledgerEntries  LedgerEntry[]
  payoutRequests PayoutRequest[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([ownerType, ownerId, currency])
}

model LedgerEntry {
  id                String       @id @default(cuid())
  walletId          String
  wallet            Wallet       @relation(fields: [walletId], references: [id])
  transactionId     String?
  transaction       Transaction? @relation(fields: [transactionId], references: [id])
  amountMinor       Int
  balanceAfterMinor Int
  description       String?
  createdAt         DateTime     @default(now())
}

model PayoutRequest {
  id          String   @id @default(cuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  amountMinor Int
  status      String   @default("pending") // pending | approved | rejected | paid
  requestedAt DateTime @default(now())
  processedAt DateTime?
  createdAt   DateTime @default(now())
}
